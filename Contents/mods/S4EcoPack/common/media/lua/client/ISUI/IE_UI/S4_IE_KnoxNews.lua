S4_IE_KnoxNews = ISPanel:derive("S4_IE_KnoxNews")

local KNOX_NEWS_TIMELINE = {
    {
        year = 1993, day = 2, month = 6, -- July is 6 (0-indexed)
        date = "July 2, 1993",
        title = "Widespread telephone outages in Knox area",
        text = "KNOX AREA – Knox Telecommunications has apologized for an hours-long outage on its networks, which continues at the time of printing, leaving thousands of Knox residents without access to telephone and internet services.\n\nThe unplanned outage has caused chaos, with many businesses that rely on telecommuting having to remain closed for the day. Others are unable to communicate with customers or suppliers. The cause of such a serious but localized outage has not been announced, but KT says they are \"working on it\" with dozens of engineers working on telephone poles throughout the area.\n\nOne expert, Kevin Hogan, told Knox Knews, \"This sort of failure is incredibly uncommon. It doesn't seem related to any single switchboard or central system. I've heard reports there are wires down or disconnected. Either they were all overloaded by a lightning strike, or this is the work of vandals or saboteurs.\"\n\nIRVINGTON – Local resident Sally Graham has said she is lucky to be alive following a fiery car crash south of the city on Thursday. Sally crashed into a wall, setting the ear on fire. Fast intervention from a passerby saved Graham's life. \"He pulled me from the car and stopped the bleeding until the ambulance could arrive. It took such a long time, with the phone lines being.",
        image = "media/textures/S4_KnoxNews/KnoxTimeline_01.png"
    },
    {
        year = 1993, day = 3, month = 6,
        date = "July 3, 1993",
        title = "\"Operation Centaur winding down\" – FBI",
        text = "Louisville — The FBI investigation into corruption in the Kentucky General Assembly, known as Operation Centaur, has now achieved its main objectives and is winding down, FBI Director Ian Clark said in a press conference in Louisville yesterday.\nDuring the operation, more than a dozen Kentucky legislators were indicted and convicted of taking bribes related to toxic waste dumping, extortion, racketeering, and conspiracy to defraud the state of Kentucky. Howe Speaker Dan Dullford has already resigned after being charged with extortion, racketeering, and lying to the FBI.\nGovernor Cal Fairweather was also caught up in the controversy and had to distance himself from two of his aides in February after their arrest for accepting bribes without the Governor's consent or knowled.",
        image = "media/textures/S4_KnoxNews/KnoxTimeline_02.png"
    },
    {
        year = 1993, day = 3, month = 6,
        date = "July 3, 1993",
        title = "Phone lines still down across area",
        text = "KNOX AREA — Knox Telecommunications has apologized for a second day of telephone outages in the Knox region. Cell and ear phone reception has also been affected, leaving both businesses and residences in turmoil. KT has claimed the outages are due to \"juvenile issues with a local telephone exchange\".\n\n----------------\nWP resident dies after eating 60 hot dogs\n\nWEST POINT — The 16th Annual West Point Hot Dog Eating competition had a tragic end as the winner, Bolton Jupiter, passed away shortly after winning. \"He held up the trophy,\" said an onlooker, \"a little wiener with shades. Then he keeled over on a bucket of mayonnaise.\"",
        image = "media/textures/S4_KnoxNews/KnoxTimeline_03.png"
    },
    {
        year = 1993, day = 4, month = 6,
        date = "July 4, 1993",
        title = "\"No danger to public\" after crash, Army says",
        text = "MARCH RIDGE — A military truck carrying hazardous waste overturned just north of March Ridge at approximately 3:15 p.m. on Saturday. The contents of the truck are not being revealed to the public, but Colonel Nigel O'Malley has said, \"The materials, though secret for operational reasons, would pose little danger even if they came into contact with the public, which they did not.\"\n\nWitnesses say the truck lost control on Route 60, south of the Furmer's Market, skidding onto the grass after narrowly missing a passing car, and overturned on the embankment. Officials did not deny that the truck was overloaded.\n\nThe scene was sealed off and secured by military personnel.",
        image = "media/textures/S4_KnoxNews/KnoxTimeline_04.png"
    },
    {
        year = 1993, day = 4, month = 6,
        date = "July 4, 1993",
        title = "Speedway could host Formula X",
        text = "Formula X organizers have given a preliminary nod to Irvington Speedway as the host track for the 1996 U.S. Grand Prix. Although the host track still remains in negotiation, officials are privately favoring the Speedway due to its location near Louisville, the track's innovative design and the openness of authorities.\n\n----------------\nKnox Knews: Two consecutive July 4's\n\nIt's been an honor to serve at Knox Knews for two consecutive July 4's. We hope our readers have a wonderful day as we remember why America was founded and dream of what it could one day be.\n\nAll the very best,\nIan J. McCarrock, Editor-in-chief",
        image = "media/textures/S4_KnoxNews/KnoxTimeline_05.png"
    },
    {
        year = 1993, day = 5, month = 6,
        date = "July 5, 1993",
        title = "EXCLUSIVE: Knox has best Independence Day ever!",
        text = "KNOX AREA — Despite the disruption of plans caused by the outgoing telephone outage in Knox, thousands of residents held family barbecues, parties, and firework displays yesterday to celebrate America's 217th birthday.\n\nAn elaborate parade of twenty decorated boats passed through Knox on its way to Loudeville. In the lead oar, Loeal elementary school student Una Turner portrayed Lady Liberty, accompanied by bands from West Point, Rivernide, and Brandanburg playing patriotic tunes.\n\nThe Knox parade had its best attendance ever.\n\nA special event was held at the drag racing circuit near West Point, where world-famous racing driver Crux Dylan was among the onlookers. However, the champion racer could not be persuaded to go for a drive himself, as he \"didn't want to make the other racers look bad.\"",
        image = "media/textures/S4_KnoxNews/KnoxTimeline_06.png"
    },
    {
        year = 1993, day = 5, month = 6,
        date = "July 5, 1993",
        title = "Spate of dog attacks \"worrisome\"",
        text = "KNOX AREA — Sheriff John Carroll has reminded residents of their responsibility to keep their dogs under control following a spate of attacks on farm animals and residents. \"Dogs should never roam free,\" the sheriff said. \"If they're at home, they should be fenced in or kept indoors so they can't escape. If a dog hites someone, the dog will (continued p.3).\n\n----------------\nFoul smell could be \"natural process\"\n\nOHIO RIVER — Joan Delahunt, a local geography teacher, has theorized that the foul smell in the Knox region is emanating from the Ohio River and may be caused by an invading alga taking root in part of the river.",
        image = "media/textures/S4_KnoxNews/KnoxTimeline_07.png"
    },
    {
        year = 1993, day = 6, month = 6,
        date = "July 6, 1993",
        title = "Dozens of Cases Reported in Area",
        text = "Muldraugh, Ky. – Dozens of cases of a flu-like illness have been reported in the area of Muldraugh, a small town just north of Fort Knox. Symptoms include severe nausea and fever.\n\nWith multiple military installations and toxic waste dumps in the area, doctors are investigating whether a chemical leak into the water supply or food chain may be responsible for the outbreak. However, calls to outside authorities for assistance are reportedly being met with obfuscation and denials.\n\n----------------\nExhibition Draws Crowd at Gallery\n\nLouisville, Ky. – The Art Gallery of Louisville hosted a new exhibition of paintings by Irish artist Ashling Dwyer, which attracted a large crowd on Monday night.\nDwyer, the winner of the 1992 Siu-Chong Prize, unveiled two new paintings, \"Pink Curtain\" and \"Yellow, Yellow, Yellow\".",
        image = "media/textures/S4_KnoxNews/KnoxTimeline_08.png"
    },
    {
        year = 1993, day = 6, month = 6,
        date = "July 6, 1993",
        title = "IRAQ MAY STOP DEALING WITH THE UN",
        text = "In a press conference on Monday, the Iraqi president warned that the country may cease its cooperation with the United Nations on the destruction of non-conventional weapons if a standoff over missile site monitoring is not resolved promptly.\n\n----------------\nTwo Arrests for 'Daring' Parisian Gem Heist\n\nFollowing a months-long investigation, Paris police made two arrests on Monday in connection with a daring heist at one of the city's most exclusive hotels. socialites Marie-Christine Lacour and Claude Beaumarchais were charged after police linked them to the theft at the Paris Havisham hotel.",
        image = "media/textures/S4_KnoxNews/KnoxTimeline_09.png"
    },
    {
        year = 1993, day = 7, month = 6,
        date = "July 7, 1993",
        title = "BLOCKADE IN KENTUCKY",
        text = "On Monday, the US military blocked roads and highways leading to and from the area of Kentucky informally known as \"Knox Country,\" which includes the counties near Fort Knox. They did not disclose the reason for the blockade.\n\nHundreds of military personnel, fully armed and in battle gear, arrived in the area early Tuesday morning. They surrounded thousands of civilians within the cordon and displaced hundreds more who live outside it. Rumors abound of a military exercise, but all calls to army officials went unanswered.\n\nTelephone lines have also been down in the area for the past several days, making communication with the cordoned-off area almost impossible.",
        image = "media/textures/S4_KnoxNews/KnoxTimeline_10.png"
    },
    {
        year = 1993, day = 13, month = 6,
        date = "July 13, 1993",
        title = "WHO: \"GROUND ALL FLIGHTS\"",
        text = "GENEVA, Switzerland- Millions of travelers were thrown into limbo when the World Health Organization on Sunday advised that all flights, excluding military and medical ones, be suspended worldwide to stop the \"Knox Virus\" from spreading.\n\nThough the WHO lacks any legal authority to enforce the advice, all flights were grounded almost immediately by airlines shocked at the sudden nature of the announcement.\n\n----------------\nOp-Ed: Worried Silence Prevails in Louisville\n\nLOUISVILLE, KY. – Despite riots and unrest in major cities, the streets of Louisville are quieter than ever. And yet, despite attempts by many residents to look on the bright side, it's clear many feel a gnawing anxiety about the Knox Virus.",
        image = "media/textures/S4_KnoxNews/KnoxTimeline_11.png"
    },
    {
        year = 1993, day = 14, month = 6,
        date = "July 14, 1993",
        title = "UN DENOUNCES KNOX RESPONSE",
        text = "NEW YORK, NY — Thirty-eight nations have issued a joint statement through the United Nations, criticizing what they called a \"complete lack of clarity\" about the details of the Knox illness outbreak.\n\n----------------\nNo Need for Panic — Gen. McGrew\n\nGen. John McGrew has stated that there is no need for further panic amidst growing concern about the lethality and infection rate of the \"Knox Virus.\"\n\n----------------\nVatican City, Mecca Close to Pilgrims\n\nTwo major religious sites are closing their doors to the outside world due to the threat of the \"Knox Virus.\" Saudi Arabia has also announced that Mecca will remain closed indefinitely.",
        image = "media/textures/S4_KnoxNews/KnoxTimeline_12.png"
    },
    {
        year = 1993, day = 15, month = 6,
        date = "July 15-16, 1993",
        title = "INFECTED OVERWHELM KNOX BORDER",
        text = "Wednesday morning at approximately 5 a.m., hundreds of people infected with the \"Knox Virus\" broke through military barricades south of Louisville, Ky. Heavy live fire failed to stop the large group's advance.\n\n----------------\nA Special Message from The Herald\n\nThis is likely to be the final edition of the Kentucky Herald. The virus has reached Louisville, and several of us here are running high fevers. If you are one of the few immune, you are the guardian of a new world.\n\n----------------\nHandful Immune to 'Aerial Strain'\n\nThe CDC has confirmed that the Knox Virus spreads rapidly through the air. However, a small percentage of people are immune. Please help your elderly and vulnerable neighbors. Avoid crowds at all costs.",
        image = "media/textures/S4_KnoxNews/KnoxTimeline_13.png"
    },
}

local KNOX_NEWS_RANDOM_EVENTS = {
    STOCK_RISE = {
        title = "MARKET ALERT: Knox Stocks Surge!",
        text = "LOUDEVILLE – The Knox County Stock Exchange saw a surprising 12% jump in trading today. Despite the ongoing telephone outages, local industries are reporting record productivity. \"The resilience of our workforce is showing,\" says investment analyst David Sterling. Investors are flocking to Kentucky-based manufacturing shares.",
        image = "media/textures/S4_KnoxNews/Event.png"
    },
    STOCK_CRASH = {
        title = "CRASH: Panic in the Markets",
        text = "LOUDEVILLE – Chaos erupted at the Stock Exchange today as massive sell-offs sent local shares plummeting. Panic followed rumors of an imminent full military blockade. Many investors are reporting being unable to reach their brokers due to the persistent phone line issues. \"This is a freefall,\" shouted one floor trader.",
        image = "media/textures/S4_KnoxNews/Event_01.png"
    },
    GUERRILLAS = {
        title = "REPORTS: Guerrilla Activity in Knox",
        text = "KNOX BORDERS – Sightings of unidentified armed groups moving through the woods have increased. Witnesses describe tactical gear but no insignia. The Military Cordon has refused to comment on these infiltrations. Citizens are strictly advised to avoid the border woods and keep their properties secured at night.",
        image = "media/textures/S4_KnoxNews/Event_02.png"
    },
    SUSPICIOUS_JOBS = {
        title = "Classified: High-Pay 'Clean-up' Jobs",
        text = "URGENT – New vacancies for 'Civilian Support Personnel' have appeared across Knox. High pay, immediate start. No experience required. Requirements include 'high physical tolerance' and 'discretion'. Many applicants report being taken in military trucks to undisclosed locations near Muldraugh.",
        image = "media/textures/S4_KnoxNews/Event_03.png"
    },
    FUEL_SHORTAGE = {
        title = "EMERGENCY: Fuel Shortage Declared",
        text = "KNOX REGION – Gas stations are running dry as supply lines are severed by the military blockade. Governor Fairweather has signed an emergency order rationing fuel for 'essential services' only. Public transit has been suspended in most areas, leaving thousands of commuters stranded.",
        image = "media/textures/S4_KnoxNews/Event_04.png"
    }
}

function S4_IE_KnoxNews:new(IEUI, x, y)
    local width = IEUI.ComUI:getWidth() - 12
    local TaskH = IEUI.ComUI:getHeight() - IEUI.ComUI.TaskBarY
    local height = IEUI.ComUI:getHeight() - ((S4_UI.FH_S * 2) + 23 + TaskH)

    local o = ISPanel:new(x, y, width, height)
    setmetatable(o, self)
    self.__index = self
    o.backgroundColor = { r = 0, g = 0, b = 0, a = 1 }
    o.borderColor = { r = 0.4, g = 0.4, b = 0.4, a = 1 }
    o.IEUI = IEUI
    o.ComUI = IEUI.ComUI
    o.player = IEUI.player
    o.Moving = true
    
    o.VisibleNews = {}
    o.CurrentNewsIndex = 1
    
    return o
end

function S4_IE_KnoxNews:initialise()
    ISPanel.initialise(self)
    local _, H, _ = S4_UI.getGoodShopSizeZ(self.ComUI)
    self.IEUI:FixUISize(817, H)

    local x = 10
    local y = 10
    local w = self:getWidth() - 20
    local h = self:getHeight() - 20
    local headerH = S4_UI.FH_M + S4_UI.FH_S + 25
    
    local textW = w * 0.8
    local textX = x + (w - textW) / 2
    local contentY = y + headerH
    local contentH = h - headerH - 50

    self.richText = ISRichTextPanel:new(textX, contentY, textW, contentH)
    self.richText:initialise()
    self.richText.backgroundColor = {r=0, g=0, b=0, a=0.0}
    self.richText.autosetheight = false
    self.richText.clip = true
    self.richText:addScrollBars()
    self:addChild(self.richText)

    local btnW = 100
    local btnH = S4_UI.FH_S + 10
    local btnY = h - btnH + 5
    
    self.prevBtn = ISButton:new(x + 20, btnY, btnW, btnH, "Previous", self, S4_IE_KnoxNews.onPrevious)
    self.prevBtn:initialise()
    self.prevBtn.borderColor = {r=1, g=1, b=1, a=0.2}
    self:addChild(self.prevBtn)

    self.nextBtn = ISButton:new(w - btnW + x - 20, btnY, btnW, btnH, "Next", self, S4_IE_KnoxNews.onNext)
    self.nextBtn:initialise()
    self.nextBtn.borderColor = {r=1, g=1, b=1, a=0.2}
    self:addChild(self.nextBtn)

    -- Debug: Test Events Button
    if getDebug() or (self.player and self.player:getAccessLevel() ~= "") then
        local testBtnW = 100
        local testBtnH = btnH
        local testBtnX = x + (w / 2) - (testBtnW / 2)
        local testBtnY = btnY
        self.testBtn = ISButton:new(testBtnX, testBtnY, testBtnW, testBtnH, "DEBUG: Test", self, S4_IE_KnoxNews.onTestEvents)
        self.testBtn:initialise()
        self.testBtn.backgroundColor = {r=0.5, g=0.2, b=0.2, a=0.8}
        self.testBtn.borderColor = {r=1, g=0, b=0, a=0.5}
        self:addChild(self.testBtn)
    end

    self:refreshVisibleNews()
    self:clearNotification()
end

function S4_IE_KnoxNews:onTestEvents()
    local modData = ModData.getOrCreate("S4_KnoxNews")
    -- Force next event check
    modData.NextEventHour = 0
    self:refreshVisibleNews()
end

function S4_IE_KnoxNews:refreshVisibleNews()
    self.VisibleNews = {}
    local gt = getGameTime()
    local gameYear = gt:getYear()
    local gameMonth = gt:getMonth() -- 0-11
    local gameDay = gt:getDay() -- 0-indexed

    -- 1. Load Timeline News
    for _, news in ipairs(KNOX_NEWS_TIMELINE) do
        local unlocked = false
        if gameYear > news.year then 
            unlocked = true
        elseif gameYear == news.year then
            if gameMonth > news.month then
                unlocked = true
            elseif gameMonth == news.month then
                if gameDay >= news.day - 1 then
                    unlocked = true
                end
            end
        end
        if unlocked then
            table.insert(self.VisibleNews, news)
        end
    end

    -- 2. Handle Random Events
    local modData = ModData.getOrCreate("S4_KnoxNews")
    local hoursSurvived = gt:getDaysSurvived() * 24

    -- Check if events are enabled in Sandbox
    local eventsEnabled = true
    if SandboxVars.S4SandBox and SandboxVars.S4SandBox.NewsRandomEvents == false then
        eventsEnabled = false
    end

    if eventsEnabled then
        local minH = 72
        local maxH = 168
        if SandboxVars.S4SandBox then
            minH = SandboxVars.S4SandBox.NewsMinHours or 72
            maxH = SandboxVars.S4SandBox.NewsMaxHours or 168
        end

        -- Initialize if new
        if not modData.NextEventHour then
            modData.NextEventHour = hoursSurvived + ZombRand(minH, maxH + 1)
            modData.CurrentEventID = nil
            modData.IsNew = false
        end

        -- Check if it's time for a new random event
        if hoursSurvived >= modData.NextEventHour then
            local eventKeys = {"STOCK_RISE", "STOCK_CRASH", "GUERRILLAS", "SUSPICIOUS_JOBS", "FUEL_SHORTAGE"}
            local newEventID = eventKeys[ZombRand(#eventKeys) + 1]
            
            modData.CurrentEventID = newEventID
            modData.IsNew = true
            modData.NextEventHour = hoursSurvived + ZombRand(minH, maxH + 1)
            modData.EventDate = "Day " .. math.floor(gt:getDaysSurvived()) .. ", 1993"
        end

        -- Add current random event if it exists
        if modData.CurrentEventID then
            local event = KNOX_NEWS_RANDOM_EVENTS[modData.CurrentEventID]
            if event then
                local eventEntry = {
                    date = modData.EventDate or "Breaking News",
                    title = event.title,
                    text = event.text,
                    image = event.image,
                    isRandom = true
                }
                table.insert(self.VisibleNews, eventEntry)
            end
        end
    end

    -- Default to the latest news available
    self.CurrentNewsIndex = #self.VisibleNews
    if self.CurrentNewsIndex < 1 then self.CurrentNewsIndex = 1 end
    
    self:updateNewsContent()
end

function S4_IE_KnoxNews:clearNotification()
    local modData = ModData.getOrCreate("S4_KnoxNews")
    modData.IsNew = false
end

function S4_IE_KnoxNews:ReloadUI()
    self:refreshVisibleNews()
    self:clearNotification()
end

function S4_IE_KnoxNews:updateNewsContent()
    if #self.VisibleNews == 0 then
        self.richText.text = " <CENTRE> <RGB:1,1,1> No news reports available at this time."
        self.richText:paginate()
        self.NewsTexture = nil
        return
    end

    if self.CurrentNewsIndex < 1 then self.CurrentNewsIndex = 1 end
    if self.CurrentNewsIndex > #self.VisibleNews then self.CurrentNewsIndex = #self.VisibleNews end
    
    local news = self.VisibleNews[self.CurrentNewsIndex]
    self.richText.text = " <CENTRE> <RGB:1,1,1> " .. news.text
    self.richText:paginate()
    
    if news.image then
        self.NewsTexture = getTexture(news.image)
    else
        self.NewsTexture = nil
    end
end

function S4_IE_KnoxNews:onPrevious()
    if #self.VisibleNews <= 1 then return end
    self.CurrentNewsIndex = self.CurrentNewsIndex - 1
    if self.CurrentNewsIndex < 1 then
        self.CurrentNewsIndex = #self.VisibleNews
    end
    self:updateNewsContent()
end

function S4_IE_KnoxNews:onNext()
    if #self.VisibleNews <= 1 then return end
    self.CurrentNewsIndex = self.CurrentNewsIndex + 1
    if self.CurrentNewsIndex > #self.VisibleNews then
        self.CurrentNewsIndex = 1
    end
    self:updateNewsContent()
end

function S4_IE_KnoxNews:prerender()
    ISPanel.prerender(self)

    local x = 10
    local y = 10
    local w = self:getWidth() - 20
    local h = self:getHeight() - 20
    
    -- Main Container Background
    self:drawRect(x, y, w, h, 1.0, 0.05, 0.05, 0.05)
    self:drawRectBorder(x, y, w, h, 1, 0.4, 0.4, 0.4)

    if #self.VisibleNews == 0 then return end
    
    local news = self.VisibleNews[self.CurrentNewsIndex]
    if not news then return end

    -- Background Image
    if self.NewsTexture then
        self:drawTextureScaled(self.NewsTexture, x + 1, y + 1, w - 2, h - 2, 0.25)
        self:drawRect(x + 1, y + 1, w - 2, h - 2, 0.5, 0, 0, 0)
    end

    -- Header
    local headerH = S4_UI.FH_M + S4_UI.FH_S + 25
    self:drawRect(x, y, w, headerH, 0.7, 0, 0, 0)
    
    local dateW = getTextManager():MeasureStringX(UIFont.Medium, news.date)
    self:drawText(news.date, x + (w/2) - (dateW/2), y + 8, 0.8, 0.8, 0.8, 1, UIFont.Medium)
    
    local titleW = getTextManager():MeasureStringX(UIFont.Large, news.title)
    self:drawText(news.title, x + (w/2) - (titleW/2), y + 8 + S4_UI.FH_M, 1, 0.9, 0.3, 1, UIFont.Large)
    
    self:drawRect(x + 20, y + headerH - 5, w - 40, 1, 0.5, 1, 1, 1)

    -- RichText Area Background
    local rtX = self.richText:getX()
    local rtY = self.richText:getY()
    local rtW = self.richText:getWidth()
    local rtH = self.richText:getHeight()
    self:drawRect(rtX - 10, rtY - 10, rtW + 20, rtH + 20, 0.6, 0, 0, 0)
    self:drawRectBorder(rtX - 10, rtY - 10, rtW + 20, rtH + 20, 0.4, 1, 1, 1)
end

function S4_IE_KnoxNews:render()
    ISPanel.render(self)

    local x = 10
    local h = self:getHeight() - 20
    local w = self:getWidth() - 20

    if #self.VisibleNews > 0 then
        local counter = string.format("%d / %d", self.CurrentNewsIndex, #self.VisibleNews)
        local counterW = getTextManager():MeasureStringX(UIFont.Small, counter)
        self:drawText(counter, x + (w/2) - (counterW/2), h - 25, 0.6, 0.6, 0.6, 1, UIFont.Small)
    end
end

function S4_IE_KnoxNews:onMouseDown(x, y)
    if self.prevBtn:isMouseOver() or self.nextBtn:isMouseOver() or self.richText:isMouseOver() then
        return 
    end
    if not self.Moving then return end
    self.IEUI.moving = true
    self.IEUI:bringToTop()
    self.ComUI.TopApp = self.IEUI
end

function S4_IE_KnoxNews:onMouseUpOutside(x, y)
    if not self.Moving then return end
    self.IEUI.moving = false
end

function S4_IE_KnoxNews:close()
    self:setVisible(false)
    self:removeFromUIManager()
end
